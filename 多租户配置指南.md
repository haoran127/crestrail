# ğŸ¢ å¤šç§Ÿæˆ·åŠŸèƒ½é…ç½®æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬ç³»ç»Ÿå®ç°äº†å®Œæ•´çš„å¤šç§Ÿæˆ·åŠŸèƒ½ï¼Œæ”¯æŒï¼š
- âœ… è¶…çº§ç®¡ç†å‘˜ï¼ˆsuperadminï¼‰ï¼šç®¡ç†æ‰€æœ‰ç§Ÿæˆ·
- âœ… ç§Ÿæˆ·ç®¡ç†å‘˜ï¼ˆtenant_adminï¼‰ï¼šç®¡ç†è‡ªå·±ç§Ÿæˆ·çš„ç”¨æˆ·å’Œèµ„æº
- âœ… ç§Ÿæˆ·ç”¨æˆ·ï¼ˆtenant_userï¼‰ï¼šè®¿é—®è‡ªå·±ç§Ÿæˆ·çš„æ•°æ®

## ğŸš€ å¿«é€Ÿé…ç½®æ­¥éª¤

### æ­¥éª¤ 1ï¼šæ‰§è¡Œæ•°æ®åº“é…ç½®è„šæœ¬

åœ¨æ•°æ®åº“ä¸­æ‰§è¡Œé…ç½®è„šæœ¬ï¼š

```bash
psql -U postgres -d crestrail -f scripts/setup_multi_tenant.sql
```

æˆ–è€…åœ¨ SQL æŸ¥è¯¢é¡µé¢ä¸­æ‰§è¡Œ `scripts/setup_multi_tenant.sql` æ–‡ä»¶çš„å†…å®¹ã€‚

è¿™ä¸ªè„šæœ¬ä¼šï¼š
1. âœ… åˆ›å»º `management` schema
2. âœ… åˆ›å»ºç§Ÿæˆ·ç›¸å…³è¡¨ï¼ˆtenants, tenant_databases, tenant_schemasç­‰ï¼‰
3. âœ… æ‰©å±• users è¡¨ï¼Œæ·»åŠ  `role` å’Œ `is_active` å­—æ®µ
4. âœ… åˆ›å»ºè¶…çº§ç®¡ç†å‘˜è´¦å·
5. âœ… åˆ›å»ºç¤ºä¾‹ç§Ÿæˆ·æ•°æ®

### æ­¥éª¤ 2ï¼šç¼–è¯‘åç«¯ä»£ç 

```bash
cd D:\code\crestrail
cargo build --release
```

### æ­¥éª¤ 3ï¼šé‡å¯åç«¯æœåŠ¡

```bash
cargo run --release
```

### æ­¥éª¤ 4ï¼šä½¿ç”¨è¶…çº§ç®¡ç†å‘˜è´¦å·ç™»å½•

**é»˜è®¤è¶…çº§ç®¡ç†å‘˜è´¦å·ï¼š**
- é‚®ç®±ï¼š`superadmin@example.com`
- å¯†ç ï¼š`admin123`

### æ­¥éª¤ 5ï¼šè®¿é—®ç§Ÿæˆ·ç®¡ç†é¡µé¢

ç™»å½•åï¼Œä¾§è¾¹æ ä¼šæ˜¾ç¤º "ç§Ÿæˆ·ç®¡ç†" èœå•ï¼ˆä»…è¶…çº§ç®¡ç†å‘˜å¯è§ï¼‰

è®¿é—®ï¼š`http://localhost:3001/dashboard/admin/tenants`

## ğŸ¯ åŠŸèƒ½è¯´æ˜

### è§’è‰²æƒé™å¯¹æ¯”

| åŠŸèƒ½ | superadmin | tenant_admin | tenant_user |
|------|------------|--------------|-------------|
| åˆ›å»º/ç®¡ç†ç§Ÿæˆ· | âœ… | âŒ | âŒ |
| æŸ¥çœ‹æ‰€æœ‰ç§Ÿæˆ· | âœ… | âŒ | âŒ |
| ç®¡ç†ç§Ÿæˆ·ç”¨æˆ· | âœ… | âœ…ï¼ˆä»…è‡ªå·±ç§Ÿæˆ·ï¼‰ | âŒ |
| è®¿é—®æ•°æ®åº“ | âœ… | âœ… | âœ… |
| åˆ‡æ¢è¿æ¥ | âœ… | âœ… | âœ… |
| SQL æŸ¥è¯¢ | âœ… | âœ… | âœ… |
| ER å›¾å¯è§†åŒ– | âœ… | âœ… | âœ… |

### è¶…çº§ç®¡ç†å‘˜åŠŸèƒ½

1. **ç§Ÿæˆ·ç®¡ç†**
   - åˆ›å»ºæ–°ç§Ÿæˆ·
   - æŸ¥çœ‹æ‰€æœ‰ç§Ÿæˆ·åˆ—è¡¨
   - ç¼–è¾‘ç§Ÿæˆ·ä¿¡æ¯
   - æš‚åœ/æ¢å¤ç§Ÿæˆ·
   - æŸ¥çœ‹ç§Ÿæˆ·è¯¦æƒ…ï¼ˆç”¨æˆ·ã€è¿æ¥ã€Schemaï¼‰

2. **ç³»ç»Ÿç»Ÿè®¡**
   - æ€»ç§Ÿæˆ·æ•°
   - æ´»è·ƒç§Ÿæˆ·æ•°
   - æ€»ç”¨æˆ·æ•°
   - æ€»è¿æ¥æ•°

3. **ç”¨æˆ·ç®¡ç†**
   - ä¸ºç§Ÿæˆ·åˆ›å»ºç®¡ç†å‘˜è´¦å·
   - æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·
   - ç®¡ç†ç”¨æˆ·æƒé™

### ç§Ÿæˆ·ç®¡ç†å‘˜åŠŸèƒ½

1. **è¿æ¥ç®¡ç†**
   - æ·»åŠ æ•°æ®åº“è¿æ¥
   - æµ‹è¯•è¿æ¥
   - åˆ‡æ¢è¿æ¥

2. **Schema ç®¡ç†**
   - é…ç½®ä¸šåŠ¡ Schema
   - è®¾ç½® Schema ç±»å‹

3. **ç”¨æˆ·ç®¡ç†**ï¼ˆå¼€å‘ä¸­ï¼‰
   - é‚€è¯·ç§Ÿæˆ·æˆå‘˜
   - åˆ†é…ç§Ÿæˆ·å†…è§’è‰²

### ç§Ÿæˆ·ç”¨æˆ·åŠŸèƒ½

1. **æ•°æ®è®¿é—®**
   - æŸ¥çœ‹è¡¨ç»“æ„
   - æ‰§è¡Œ SQL æŸ¥è¯¢
   - å¯¼å‡ºæ•°æ®
   - ER å›¾å¯è§†åŒ–

2. **è¿æ¥åˆ‡æ¢**
   - åœ¨å¯è®¿é—®çš„è¿æ¥é—´åˆ‡æ¢

## ğŸ“Š æ•°æ®åº“ç»“æ„

### Management Schema

```
management
â”œâ”€â”€ tenants                    # ç§Ÿæˆ·è¡¨
â”œâ”€â”€ tenant_databases           # ç§Ÿæˆ·æ•°æ®åº“è¿æ¥é…ç½®
â”œâ”€â”€ tenant_schemas             # ç§Ÿæˆ·ä¸šåŠ¡ Schema
â”œâ”€â”€ user_tenants               # ç”¨æˆ·-ç§Ÿæˆ·å…³è”
â”œâ”€â”€ connection_access_logs     # è¿æ¥è®¿é—®æ—¥å¿—
â”œâ”€â”€ v_tenant_info              # ç§Ÿæˆ·ä¿¡æ¯è§†å›¾
â””â”€â”€ v_user_connections         # ç”¨æˆ·è¿æ¥è§†å›¾
```

### Users è¡¨æ‰©å±•

æ·»åŠ äº†ä»¥ä¸‹å­—æ®µï¼š
- `role` - å…¨å±€è§’è‰²ï¼ˆsuperadmin/tenant_admin/tenant_userï¼‰
- `is_active` - è´¦å·æ˜¯å¦æ¿€æ´»

## ğŸ”§ API æ¥å£

### è¶…ç®¡æ¥å£ï¼ˆéœ€è¦ superadmin è§’è‰²ï¼‰

```
GET    /api/admin/tenants              # è·å–æ‰€æœ‰ç§Ÿæˆ·åˆ—è¡¨
POST   /api/admin/tenants              # åˆ›å»ºæ–°ç§Ÿæˆ·
GET    /api/admin/tenants/:id          # è·å–ç§Ÿæˆ·è¯¦æƒ…
PATCH  /api/admin/tenants/:id          # æ›´æ–°ç§Ÿæˆ·ä¿¡æ¯
GET    /api/admin/stats                # è·å–ç³»ç»Ÿç»Ÿè®¡
```

### ç§Ÿæˆ·æ¥å£ï¼ˆéœ€è¦è®¤è¯ï¼‰

```
GET    /api/tenants/my-connections           # è·å–æˆ‘çš„è¿æ¥
GET    /api/tenants/:tenant_id/schemas       # è·å–ç§Ÿæˆ· Schema
POST   /api/tenants/test-connection          # æµ‹è¯•è¿æ¥
POST   /api/tenants/connections              # åˆ›å»ºè¿æ¥
POST   /api/tenants/switch-connection        # åˆ‡æ¢è¿æ¥
GET    /api/tenants/pool-stats               # è¿æ¥æ± ç»Ÿè®¡
```

## ğŸ¨ å‰ç«¯é¡µé¢

### è¶…ç®¡ä¸“ç”¨é¡µé¢

- `/dashboard/admin/tenants` - ç§Ÿæˆ·ç®¡ç†
- `/dashboard/admin/tenants/:id` - ç§Ÿæˆ·è¯¦æƒ…ï¼ˆå¾…å®ç°ï¼‰
- `/dashboard/admin/users` - ç”¨æˆ·ç®¡ç†ï¼ˆå¾…å®ç°ï¼‰

### é€šç”¨é¡µé¢

- `/dashboard/visualizer` - ER å›¾å¯è§†åŒ–
- `/dashboard/connections` - æˆ‘çš„è¿æ¥
- `/dashboard/data` - æ•°æ®æµè§ˆ
- `/dashboard/sql` - SQL æŸ¥è¯¢

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### 1. åˆ›å»ºæ–°ç§Ÿæˆ·

1. ä½¿ç”¨è¶…çº§ç®¡ç†å‘˜ç™»å½•
2. è®¿é—® "ç§Ÿæˆ·ç®¡ç†" é¡µé¢
3. ç‚¹å‡» "åˆ›å»ºç§Ÿæˆ·"
4. å¡«å†™ç§Ÿæˆ·ä¿¡æ¯å’Œç®¡ç†å‘˜è´¦å·
5. æäº¤åˆ›å»º

### 2. ä¸ºç§Ÿæˆ·æ·»åŠ æ•°æ®åº“è¿æ¥

1. ä½¿ç”¨ç§Ÿæˆ·ç®¡ç†å‘˜ç™»å½•
2. è®¿é—® "è¿æ¥ç®¡ç†" é¡µé¢
3. ç‚¹å‡» "æ·»åŠ è¿æ¥"
4. å¡«å†™æ•°æ®åº“è¿æ¥ä¿¡æ¯
5. æµ‹è¯•è¿æ¥
6. ä¿å­˜

### 3. åˆ‡æ¢æ•°æ®åº“è¿æ¥

1. ç‚¹å‡»ä¾§è¾¹æ é¡¶éƒ¨çš„è¿æ¥é€‰æ‹©å™¨
2. é€‰æ‹©è¦åˆ‡æ¢çš„è¿æ¥
3. ç³»ç»Ÿè‡ªåŠ¨åˆ‡æ¢ï¼Œç›¸å…³é¡µé¢è‡ªåŠ¨åˆ·æ–°

## ğŸ”’ å®‰å…¨æ³¨æ„äº‹é¡¹

1. **å¯†ç åŠ å¯†**
   - æ•°æ®åº“è¿æ¥å¯†ç ä½¿ç”¨ç®€å•åŠ å¯†å­˜å‚¨
   - ç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨ AES æˆ–å…¶ä»–å¼ºåŠ å¯†ç®—æ³•

2. **æƒé™æ£€æŸ¥**
   - æ‰€æœ‰è¶…ç®¡æ¥å£éƒ½ä¼šæ£€æŸ¥ç”¨æˆ·è§’è‰²
   - ç§Ÿæˆ·ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±ç§Ÿæˆ·çš„æ•°æ®

3. **Token ç®¡ç†**
   - JWT Token åŒ…å«ç”¨æˆ·è§’è‰²ä¿¡æ¯
   - å®šæœŸåˆ·æ–° Token

4. **å®¡è®¡æ—¥å¿—**
   - è®°å½•æ‰€æœ‰è¿æ¥åˆ‡æ¢æ“ä½œ
   - è®°å½•æ•æ„Ÿæ“ä½œï¼ˆåˆ›å»º/åˆ é™¤ç§Ÿæˆ·ï¼‰

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šç™»å½•åæç¤º "æ— æƒè®¿é—®"

**åŸå› ï¼š** ç”¨æˆ·è§’è‰²ä¸æ˜¯ superadmin

**è§£å†³ï¼š**
```sql
UPDATE users SET role = 'superadmin' WHERE email = 'your@email.com';
```

### é—®é¢˜ 2ï¼šç§Ÿæˆ·ç®¡ç†èœå•ä¸æ˜¾ç¤º

**åŸå› ï¼š** å‰ç«¯æ²¡æœ‰æ­£ç¡®è¯»å–ç”¨æˆ·è§’è‰²

**è§£å†³ï¼š**
1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
2. é‡æ–°ç™»å½•
3. æ£€æŸ¥æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯

### é—®é¢˜ 3ï¼š500 é”™è¯¯ "relation management.tenants does not exist"

**åŸå› ï¼š** æ²¡æœ‰æ‰§è¡Œé…ç½®è„šæœ¬

**è§£å†³ï¼š**
```bash
psql -U postgres -d crestrail -f scripts/setup_multi_tenant.sql
```

## ğŸ“š ä¸‹ä¸€æ­¥å¼€å‘

- [ ] ç§Ÿæˆ·ç”¨æˆ·é‚€è¯·åŠŸèƒ½
- [ ] ç§Ÿæˆ·å†…è§’è‰²ç»†åˆ†
- [ ] æ•°æ®éš”ç¦»ç­–ç•¥
- [ ] ç§Ÿæˆ·é…é¢ç®¡ç†
- [ ] å®¡è®¡æ—¥å¿—æŸ¥çœ‹ç•Œé¢
- [ ] ç§Ÿæˆ·ç»Ÿè®¡dashboard

## ğŸ¤ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- åç«¯æ—¥å¿—ï¼š`cargo run` è¾“å‡º
- å‰ç«¯æ§åˆ¶å°ï¼šæµè§ˆå™¨å¼€å‘è€…å·¥å…·
- æ•°æ®åº“æ—¥å¿—ï¼šPostgreSQL æ—¥å¿—æ–‡ä»¶

---

**é…ç½®å®Œæˆåï¼Œæ‚¨å°†æ‹¥æœ‰ä¸€ä¸ªå®Œæ•´çš„å¤šç§Ÿæˆ·æ•°æ®åº“ç®¡ç†å¹³å°ï¼** ğŸ‰

